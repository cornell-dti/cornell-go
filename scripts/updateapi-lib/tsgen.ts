import { ApiDefs, DtoDefs } from "./types";

export function genTsDtoFile(dtoDefs: DtoDefs) {
  let tsCode = `
  // CODE AUTOGENERATED BY npm run updateapi
  // IF YOU MODIFY THIS FILE, MAKE SURE TO ALSO MODIFY THE updateapi SCRIPT!
  // OTHERWISE YOUR CHANGES MAY BE OVERWRITTEN!
  `;

  for (const [name, fields] of dtoDefs.enumDtos.entries()) {
    tsCode += `export enum ${name} {`;
    for (const field of fields) {
      tsCode += `\n  ${field} = "${field}",`;
    }
    tsCode += "}\n\n";
  }

  for (const [name, propMap] of dtoDefs.baseDtos.entries()) {
    tsCode += `export interface ${name} {\n`;
    for (const [
      propName,
      [typeName, fieldType, isOptional],
    ] of propMap.entries()) {
      const isArray =
        fieldType == "ENUM_DTO[]" ||
        fieldType == "DEPENDENT_DTO[]" ||
        fieldType == "PRIMITIVE[]";

      const fullType = isArray ? `${typeName}[]` : typeName;

      tsCode += `  ${propName}`;
      if (isOptional) {
        tsCode += "?";
      }
      tsCode += `: ${fullType};\n`;
    }

    tsCode += "}\n\n";
  }

  return tsCode;
}

export function getAdminApiFile(apiDefs: ApiDefs) {
  let tsCode = `
    // CODE AUTOGENERATED BY npm run updateapi
    // IF YOU MODIFY THIS FILE, MAKE SURE TO ALSO MODIFY THE updateapi SCRIPT!
    // OTHERWISE YOUR CHANGES MAY BE OVERWRITTEN!

    import { Socket } from "socket.io-client";
    import * as dto from "../all.dto";

    export class ServerApi {
      constructor(private socket: Socket) {}

      send(ev: string, data: {}) {
        console.log(\`Sending \${ev} with \${JSON.stringify(data)}\`);
        return this.socket.timeout(5000).emitWithAck(ev, data);
      }

  `;

  for (const [ev, dto] of apiDefs.serverEntrypoints.entries()) {
    const ackType = apiDefs.serverAcks.get(ev);
    tsCode += `
      ${ev}(data: dto.${dto}) {
        return this.send("${ev}", data) as Promise<${ackType} | undefined>;
      }

    `;
  }

  for (const [ev, dto] of apiDefs.clientEntrypoints.entries()) {
    const formattedName = ev[0].toUpperCase() + ev.substring(1);

    tsCode += `
      on${formattedName}(callback: (data: dto.${dto}) => void) {
        this.socket.removeAllListeners("${ev}");
        this.socket.on("${ev}", (data) => callback(data));
      }

    `;
  }

  tsCode += "}";

  return tsCode;
}
